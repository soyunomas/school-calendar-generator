<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Calendarios Escolares y Mensuales</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Lato:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --calendar-bg: #ffffff;
            --calendar-text-color: #000000;
            --calendar-border-color: #000000;
            --calendar-header-bg: #cccccc;
            --calendar-header-text: #000000;
            --calendar-day-number-color: #333333;
            --calendar-weekend-bg: #e0e0e0;
            --calendar-empty-cell-bg: #f0f0f0;
            --calendar-border-width: 1.5px;
            --calendar-font-family: 'Lato', sans-serif;
            --calendar-font-size-base: 1rem;
            --calendar-day-number-size: 0.8em;
            --annual-weekend-highlight-color: rgba(255, 0, 0, 0.1);
            --tool-active-bg: #0d6efd;
            --tool-active-text: #ffffff;
        }

        body.theme-default {
             --calendar-bg: #ffffff;
             --calendar-text-color: #212529;
             --calendar-border-color: #dee2e6;
             --calendar-header-bg: #e9ecef;
             --calendar-header-text: #495057;
             --calendar-day-number-color: #6c757d;
             --calendar-weekend-bg: #f8f9fa;
             --calendar-empty-cell-bg: #ffffff;
             --calendar-border-width: 1px;
             --annual-weekend-highlight-color: rgba(255, 0, 0, 0.07);
        }
        body.theme-contrast {
             --calendar-border-color: #000000;
             --annual-weekend-highlight-color: rgba(220, 20, 60, 0.15);
        }

        body.theme-pastel-rose {
            --calendar-bg: #ffffff; --calendar-border-color: #8B4561; --calendar-header-bg: #ffe4e1;
            --calendar-weekend-bg: #fff5f8; --calendar-empty-cell-bg: #ffffff; --calendar-header-text: #783f50;
            --calendar-day-number-color: #c71585; --calendar-border-width: 1px; --annual-weekend-highlight-color: rgba(255, 182, 193, 0.3);
        }
        body.theme-pastel-rose #monthly-main-title { color: #c71585; }

        body.theme-pastel-mint {
            --calendar-bg: #ffffff; --calendar-border-color: #2E8B57; --calendar-header-bg: #d4f0d4;
            --calendar-weekend-bg: #f0fff0; --calendar-empty-cell-bg: #ffffff; --calendar-header-text: #2E8B57;
            --calendar-day-number-color: #3CB371; --annual-weekend-highlight-color: rgba(144, 238, 144, 0.3);
        }
        body.theme-pastel-mint #monthly-main-title { color: #2e8b57; }

        body.theme-serene-sky {
            --calendar-bg: #ffffff; --calendar-border-color: #191970; --calendar-header-bg: #e0f7ff;
            --calendar-weekend-bg: #f0f8ff; --calendar-empty-cell-bg: #ffffff; --calendar-header-text: #191970;
            --calendar-day-number-color: #4682b4; --annual-weekend-highlight-color: rgba(173, 216, 230, 0.3);
        }
        body.theme-serene-sky #monthly-main-title { color: #4682b4; }

        body.theme-soft-lavender {
            --calendar-bg: #ffffff; --calendar-border-color: #483D8B; --calendar-header-bg: #e6e6fa;
            --calendar-weekend-bg: #f8f8ff; --calendar-empty-cell-bg: #ffffff; --calendar-header-text: #483D8B;
            --calendar-day-number-color: #6A5ACD; --annual-weekend-highlight-color: rgba(216, 191, 216, 0.3);
        }
        body.theme-soft-lavender #monthly-main-title { color: #483d8b; }

        body.theme-peach-dream {
            --calendar-bg: #ffffff; --calendar-border-color: #8B4513; --calendar-header-bg: #ffe5b4;
            --calendar-weekend-bg: #fff8dc; --calendar-empty-cell-bg: #ffffff; --calendar-header-text: #8B4513;
            --calendar-day-number-color: #D2691E; --annual-weekend-highlight-color: rgba(255, 218, 185, 0.3);
        }
        body.theme-peach-dream #monthly-main-title { color: #d2691e; }

        body.theme-lemon-zest {
            --calendar-bg: #ffffff; --calendar-border-color: #B8860B; --calendar-header-bg: #fffacd;
            --calendar-weekend-bg: #fffef0; --calendar-empty-cell-bg: #ffffff; --calendar-header-text: #B8860B;
            --calendar-day-number-color: #FFD700; --annual-weekend-highlight-color: rgba(255, 250, 205, 0.4);
        }
        body.theme-lemon-zest #monthly-main-title { color: #b8860b; }

        body.theme-aqua-mist {
            --calendar-bg: #ffffff; --calendar-border-color: #008B8B; --calendar-header-bg: #e0ffff;
            --calendar-weekend-bg: #f0ffff; --calendar-empty-cell-bg: #ffffff; --calendar-header-text: #008B8B;
            --calendar-day-number-color: #40E0D0; --annual-weekend-highlight-color: rgba(175, 238, 238, 0.3);
        }
         body.theme-aqua-mist #monthly-main-title { color: #008b8b; }

        body.theme-coral-blush {
            --calendar-bg: #ffffff; --calendar-border-color: #A52A2A; --calendar-header-bg: #ffc0cb;
            --calendar-weekend-bg: #fff5f5; --calendar-empty-cell-bg: #ffffff; --calendar-header-text: #A52A2A;
            --calendar-day-number-color: #FF6347; --annual-weekend-highlight-color: rgba(255, 127, 80, 0.25);
        }
        body.theme-coral-blush #monthly-main-title { color: #dc143c; }

        body.theme-spring-meadow {
            --calendar-bg: #ffffff; --calendar-border-color: #228B22; --calendar-header-bg: #d0f0c0;
            --calendar-weekend-bg: #f5fff5; --calendar-empty-cell-bg: #ffffff; --calendar-header-text: #228B22;
            --calendar-day-number-color: #6B8E23; --annual-weekend-highlight-color: rgba(152, 251, 152, 0.3);
        }
        body.theme-spring-meadow #monthly-main-title { color: #228b22; }

        body.theme-sandstone {
            --calendar-bg: #ffffff; --calendar-border-color: #8B4513; --calendar-header-bg: #f5deb3;
            --calendar-weekend-bg: #fdf5e6; --calendar-empty-cell-bg: #ffffff; --calendar-header-text: #8B4513;
            --calendar-day-number-color: #A0522D; --annual-weekend-highlight-color: rgba(244, 164, 96, 0.25);
        }
        body.theme-sandstone #monthly-main-title { color: #8b4513; }

        body[class^="theme-pastel-"], body.theme-serene-sky, body.theme-peach-dream, body.theme-lemon-zest, body.theme-aqua-mist, body.theme-coral-blush, body.theme-spring-meadow, body.theme-sandstone {
             --calendar-text-color: #212529;
        }

        body {
            background-color: #f8f9fa; font-family: var(--calendar-font-family); color: var(--calendar-text-color);
            padding-top: 56px; transition: background-color 0.3s ease, color 0.3s ease;
        }
        .view-wrapper { display: none; }
        .view-wrapper.active { display: block; }
        .container-fluid { max-width: 1280px; }

        #annual-view-wrapper #annual-main-title { text-align: center; margin-bottom: 0.25rem; }
        #annual-view-wrapper #annual-main-title[contenteditable="true"] { cursor: text; padding: 0.2rem 0.5rem; border: 1px dashed transparent; transition: border-color 0.2s ease; }
        #annual-view-wrapper #annual-main-title[contenteditable="true"]:hover,
        #annual-view-wrapper #annual-main-title[contenteditable="true"]:focus { border-color: #adb5bd; outline: none; background-color: rgba(0, 0, 0, 0.03); }
        #annual-view-wrapper .editable-hint { font-size: 0.8rem; text-align: center; color: #6c757d; margin-top: -0.2rem; margin-bottom: 0.5rem; min-height: 1em; }
        #annual-view-wrapper #calendar-year-range-display { font-size: 1.8rem; font-weight: bold; text-align: center; margin-bottom: 0.1rem; }
        #annual-view-wrapper #calendar-view-subtitle { font-size: 1rem; text-align: center; color: #6c757d; margin-top: -0.1rem; margin-bottom: 1rem; min-height: 1.5em; }
        
        #annual-view-wrapper .month-container {
            margin-bottom: 2.5rem; 
            padding: 0; 
            display: none;
        }
        #annual-view-wrapper .month-container.visible {
            display: block;
        }
        #annual-view-wrapper .month-name { font-size: 0.9rem; font-weight: bold; text-align: center; margin-bottom: 0.3rem; }
        #annual-view-wrapper .month-name .year-suffix { font-size: 0.7rem; font-weight: normal; color: #888; margin-left: 3px; }
        #annual-view-wrapper .calendar-table { width: 100%; table-layout: fixed; border-collapse: collapse; font-size: 0.7rem; text-align: center; }
        #annual-view-wrapper .calendar-table th { font-weight: bold; padding: 0.1rem 0; color: #555; font-size: 0.65rem;}
        #annual-view-wrapper .calendar-table td {
            padding: 0.5rem 0; 
            border: none;
            line-height: 1.2; 
            position: relative;
        }
        #annual-view-wrapper .calendar-table .annual-weekend-day { background-color: var(--annual-weekend-highlight-color); border-radius: 2px; }
        #annual-view-wrapper .calendar-table .empty-day { visibility: hidden; }
        #annual-view-wrapper .controls-container { margin-bottom: 1rem; padding: 0.5rem 0; text-align: center; border-bottom: 1px solid #eee; background-color: #fff; border-radius: 0.25rem; }
        #annual-view-wrapper .controls-container label { margin-right: 0.5rem; font-size: 0.9rem; }
        #annual-view-wrapper .controls-container input[type="number"] { width: 80px; padding: 0.2rem 0.4rem; font-size: 0.9rem; margin-right: 0.5rem; vertical-align: middle; }
        #annual-view-wrapper .controls-container .btn { padding: 0.2rem 0.8rem; font-size: 0.9rem; vertical-align: middle; margin-left: 10px; }
        #annual-view-wrapper .controls-container .form-check-label { font-size: 0.9rem; vertical-align: middle; }
        #annual-view-wrapper .controls-container .form-check-input { vertical-align: middle; }
        #annual-view-wrapper .controls-container .form-check { margin-left: 0.5rem; display: inline-block; }

        #monthly-view-wrapper .calendar-section-wrapper { background-color: var(--calendar-bg); color: var(--calendar-text-color); border: 1px solid var(--calendar-border-color); padding: 1rem; border-radius: 0.25rem; margin-top: 1rem; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        #monthly-view-wrapper #monthly-main-title { text-align: center; transition: color 0.3s ease; }
        #monthly-view-wrapper #monthly-main-title[contenteditable="true"] { cursor: text; padding: 0.2rem 0.5rem; border: 1px dashed transparent; transition: border-color 0.2s ease, background-color 0.2s ease; display: inline-block; }
        #monthly-view-wrapper #monthly-main-title[contenteditable="true"]:hover,
        #monthly-view-wrapper #monthly-main-title[contenteditable="true"]:focus { border-color: #adb5bd; outline: none; background-color: rgba(0, 0, 0, 0.03); }
        #monthly-view-wrapper .editable-hint { font-size: 0.8rem; text-align: center; color: #6c757d; margin-top: 0; margin-bottom: 1rem; min-height: 1em; display: block; }
        #monthly-view-wrapper .calendar-table { width: 100%; border-collapse: collapse; background-color: var(--calendar-bg); color: var(--calendar-text-color); transition: background-color 0.3s ease; }
        #monthly-view-wrapper .calendar-table th { text-align: center; font-weight: bold; background-color: var(--calendar-header-bg); color: var(--calendar-header-text); padding: 0.5rem; width: 14.28%; border: var(--calendar-border-width) solid var(--calendar-border-color); transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        #monthly-view-wrapper .calendar-table td { height: 100px; vertical-align: top; padding: 0.3rem; position: relative; border: var(--calendar-border-width) solid var(--calendar-border-color); font-family: var(--calendar-font-family); color: var(--calendar-text-color); background-color: var(--calendar-bg); transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; cursor: default; }
        
        /* Cambio 2: Ajuste del centrado vertical del lápiz */
        #monthly-view-wrapper .calendar-table td .day-content-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%; /* Ocupa el espacio de contenido del TD padre (td height - td padding) */
            box-sizing: border-box; /* Padding no aumenta el tamaño total */
            position: relative; /* Para el .day-number absoluto */
            padding-top: 1.5em;  /* Espacio para el day-number (font-size: 0.8em, top: 2px). 1.5em relativo al font-size del wrapper */
            padding-left: 2px;   /* Pequeño padding lateral */
            padding-right: 2px;
            padding-bottom: 2px; /* Pequeño padding inferior */
        }
        #monthly-view-wrapper .calendar-table td .day-number { font-size: var(--calendar-day-number-size); font-weight: bold; color: var(--calendar-day-number-color); position: absolute; top: 2px; right: 4px; transition: color 0.3s ease; z-index: 1; }
        #monthly-view-wrapper .calendar-table td.empty-cell { background-color: var(--calendar-empty-cell-bg); cursor: not-allowed; }
        #monthly-view-wrapper .calendar-table td.weekend-cell { background-color: var(--calendar-weekend-bg); }
        #monthly-view-wrapper #settings-button { font-size: 1.5rem; }
        #monthly-view-wrapper .controls-section { background-color: #fff; }

        .annotation-toolbar { background-color: #f8f9fa; padding: 0.5rem; margin-bottom: 1rem; border-radius: 0.25rem; border: 1px solid #dee2e6; display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; }
        .annotation-toolbar .tool-group { display: flex; align-items: center; }
        .annotation-toolbar .tool-group .btn-group .btn { font-size: 0.85rem; padding: 0.25rem 0.6rem; }
        .annotation-toolbar .tool-group .btn-group .btn.active { background-color: var(--tool-active-bg); color: var(--tool-active-text); border-color: var(--tool-active-bg); }
        .annotation-toolbar .tool-options { display: none; align-items: center; gap: 0.5rem; margin-left: 0.5rem; padding-left: 0.5rem; border-left: 1px solid #ccc; }
        .annotation-toolbar .tool-options.active { display: flex; flex-wrap: wrap; }
        .annotation-toolbar .tool-options label { font-size: 0.8rem; margin-bottom: 0; margin-right: 0.25rem; }
        .annotation-toolbar .tool-options .form-select-sm,
        .annotation-toolbar .tool-options .form-control-sm { font-size: 0.8rem; max-width: 120px; }
        .annotation-toolbar .tool-options input[type="color"] { width: 30px; height: 30px; padding: 0.1rem; border: 1px solid #ccc; border-radius: 0.25rem; cursor: pointer; }
        .annotation-toolbar .tool-options .btn-group .btn { font-size: 0.85rem; padding: 0.25rem 0.6rem; }
        .annotation-toolbar .tool-options .btn-group .btn.active { background-color: var(--tool-active-bg); color: var(--tool-active-text); border-color: var(--tool-active-bg); }
        .annotation-toolbar .color-palette button { width: 24px; height: 24px; border-radius: 50%; border: 1px solid #ccc; margin: 0 2px; padding: 0; }
        .annotation-toolbar .color-palette button.active { border-width: 2px; border-color: var(--tool-active-bg); box-shadow: 0 0 0 1px white, 0 0 0 2px var(--tool-active-bg); }
        #annual-annotation-toolbar-wrapper .annotation-toolbar button[data-tool="pencil"],
        #annual-annotation-toolbar-wrapper .annotation-toolbar .tool-options[data-tool-options="pencil"] { display: none !important; }

        .day-annotation-text {
            font-size: 0.75rem;
            word-wrap: break-word;
            white-space: pre-wrap;
            /* padding y margin-top eliminados, ahora gestionados por .day-content-wrapper */
            line-height: 1.3;
            cursor: text;
            overflow-y: auto; /* Para scroll si el texto es largo */
            max-height: 100%; /* Para asegurar que no desborde el wrapper si es muy largo, permitiendo scroll */
        }
        .day-mark-symbol { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2.5rem; font-weight: bold; pointer-events: none; z-index: 0; }
        #annual-view-wrapper .calendar-table td .day-mark-symbol { font-size: 0.9rem; line-height: 1; }
        #annual-view-wrapper .calendar-table td .annual-day-bg-highlight { position: absolute; top: 1px; bottom: 1px; left: 1px; right: 1px; border-radius: 2px; opacity: 0.7; pointer-events: none; z-index: -1; }

 @media print {
     @page { margin: 8mm; }
    .navbar, .d-print-none, #settings-button, .controls-section, .annotation-toolbar, .modal, .modal-backdrop, .editable-hint { display: none !important; }
    body { padding-top: 0 !important; background-color: #fff !important; font-size: 10pt; font-family: var(--calendar-font-family, sans-serif); -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    .container-fluid { max-width: 100% !important; width: 100% !important; padding: 0 !important; margin: 0 !important; }
    .view-wrapper:not(.active) { display: none !important; }
    #annual-view-wrapper .controls-container { display: none !important; }
    #annual-view-wrapper { padding: 0 5mm; }
    #annual-view-wrapper #annual-main-title[contenteditable="true"],
    #annual-view-wrapper #annual-main-title { border: none !important; padding: 0 !important; cursor: default; background-color: transparent !important; font-size: 38pt !important; text-align: center; margin-bottom: 2mm; color: #000 !important; display: block !important; }
    #annual-view-wrapper #calendar-year-range-display { font-size: 24pt; margin-bottom: 0.1cm; color: #000 !important; }
    #annual-view-wrapper #calendar-view-subtitle { display: none !important; }
    #annual-view-wrapper #annual-calendar-container.row { display: flex !important; flex-wrap: wrap !important; align-items: flex-start; justify-content: flex-start; }
    
    #annual-view-wrapper .month-container.visible {
        display: block !important; 
        flex: 0 0 30.3%; 
        max-width: 30.3%; 
        margin-left: 1.5%; 
        margin-right: 1.5%; 
        margin-bottom: 1cm; 
        page-break-inside: avoid !important; 
        border: 1px solid #ccc;
        padding: 2px; 
        box-sizing: border-box;
     }

     #annual-view-wrapper .month-name { font-size: 8pt; color: #000 !important;}
     #annual-view-wrapper .month-name .year-suffix { color: #333 !important; }
     #annual-view-wrapper .calendar-table { font-size: 6pt; color: #000 !important; }
     #annual-view-wrapper .calendar-table th { color: #000 !important; padding: 0.1px 0; font-weight: bold; }
     #annual-view-wrapper .calendar-table td {
         color: #000 !important;
         padding: 3.5pt 0; 
         background-color: transparent !important;
         vertical-align: middle; 
     }
     #annual-view-wrapper .calendar-table .annual-weekend-day { background-color: var(--annual-weekend-highlight-color) !important; }
     #annual-view-wrapper .calendar-table .annual-day-bg-highlight { opacity: 0.7 !important; }
     #annual-view-wrapper .calendar-table .empty-day { visibility: hidden; }

     #monthly-view-wrapper #monthly-main-title[contenteditable="true"],
     #monthly-view-wrapper #monthly-main-title { border: none !important; padding: 0 !important; cursor: default; background-color: transparent !important; font-size: 38pt !important; text-align: center; margin-bottom: 2mm; color: #000 !important; display: block !important; }
     #monthly-view-wrapper header.mb-3 { margin-bottom: 0 !important; }
     #monthly-view-wrapper #calendar-output { margin-top: 0 !important; }
     #monthly-view-wrapper .calendar-section-wrapper { border: none !important; padding: 0; background-color: transparent !important; color: var(--calendar-text-color); }
     #monthly-view-wrapper #calendar-title { display: block !important; text-align: center; font-size: 28pt; font-weight: normal; margin-bottom: 5mm; color: var(--calendar-header-text, #000); }
     #monthly-view-wrapper .calendar-table { border-collapse: collapse; width: 100%; color: var(--calendar-text-color); }
     #monthly-view-wrapper .calendar-table th,
     #monthly-view-wrapper .calendar-table td { border: var(--calendar-border-width, 1px) solid var(--calendar-border-color, #000) !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
     #monthly-view-wrapper .calendar-table th { background-color: var(--calendar-header-bg) !important; color: var(--calendar-header-text) !important; font-weight: bold; text-align: center; padding: 0.3rem; }
     #monthly-view-wrapper .calendar-table td { height: 2.6cm; font-size: 9pt; vertical-align: top; padding: 0.3rem; position: relative; background-color: var(--calendar-bg); }
     #monthly-view-wrapper .calendar-table td .day-number { color: var(--calendar-day-number-color) !important; font-size: 0.7em; position: absolute; top: 2px; right: 4px; }
     #monthly-view-wrapper .calendar-table td.weekend-cell { background-color: var(--calendar-weekend-bg) !important; }
     #monthly-view-wrapper .calendar-table td.empty-cell { background-color: var(--calendar-empty-cell-bg) !important; border-color: var(--calendar-border-color, #ccc) !important; }
     #monthly-view-wrapper .day-annotation-text { }
}
    /* Cambio 1: Ajuste de margen para calendario anual imprimible en apaisado */
    @media print and (orientation: landscape) {
        #annual-view-wrapper .month-container.visible {
            margin-bottom: 0.25cm; /* Reducido desde 1cm para mejor ajuste en altura */
        }
        /* Opcional: si aún no caben, se podría reducir un poco el padding de las celdas td */
        /* #annual-view-wrapper .calendar-table td { padding: 2.8pt 0; } */
    }
    </style>
</head>
<body class="theme-contrast">

    <nav class="navbar navbar-expand-sm navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Calendarios</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-sm-0">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-view="annual">Vista Anual</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-view="monthly">Vista Mensual</a>
                    </li>
                </ul>
                <button id="general-print-btn" class="btn btn-outline-light btn-sm d-none d-sm-inline-block">
                    <i class="bi bi-printer-fill"></i> Imprimir Vista Actual
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">

        <div id="annual-view-wrapper" class="view-wrapper">
            <div class="controls-container d-print-none">
                <label for="annual-year-select">Año (inicio):</label>
                <input type="number" id="annual-year-select" class="form-control form-control-sm d-inline-block w-auto" value="2024">

                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="viewSelectionAnnual" id="viewSchoolYear" value="school" checked>
                    <label class="form-check-label" for="viewSchoolYear">
                        Año Escolar (Sep-Jun)
                    </label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="viewSelectionAnnual" id="viewFullYear" value="full">
                    <label class="form-check-label" for="viewFullYear">
                        Año Completo
                    </label>
                </div>
            </div>

            <div id="annual-annotation-toolbar-wrapper" class="annotation-toolbar-container d-print-none mb-3">
                </div>

            <h1 id="annual-main-title" contenteditable="true" class="d-print-inline">Calendario Anual</h1>
            <p class="editable-hint d-print-none">Haz clic en el título para editarlo.</p>
            <h2 id="calendar-year-range-display"></h2>
            <p id="calendar-view-subtitle"></p>

            <div id="annual-calendar-container" class="row gx-4"> 
            </div>
        </div>

        <div id="monthly-view-wrapper" class="view-wrapper">
            <header class="d-flex justify-content-between align-items-center mb-3">
                 <div class="text-center flex-grow-1">
                     <h1 id="monthly-main-title" contenteditable="true" class="d-print-inline">Calendario Mensual Personalizable</h1>
                     <p class="editable-hint d-print-none">Haz clic en el título para editarlo.</p>
                 </div>
                 <button id="settings-button" class="btn btn-light d-print-none ms-3" type="button" data-bs-toggle="modal" data-bs-target="#settingsModal" aria-label="Abrir configuración">
                     <i class="bi bi-gear-fill fs-5"></i>
                 </button>
            </header>

            <section class="controls-section card p-3 mb-4 d-print-none">
                 <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label for="monthly-month-select" class="form-label">Mes:</label>
                        <select id="monthly-month-select" class="form-select">
                             <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="monthly-year-select" class="form-label">Año:</label>
                        <select id="monthly-year-select" class="form-select"></select>
                    </div>
                 </div>
            </section>

            <div id="monthly-annotation-toolbar-wrapper" class="annotation-toolbar-container d-print-none mb-3">
            </div>

            <div class="modal fade d-print-none" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">Configuración y Estilos (Mensual)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                  </div>
                  <div class="modal-body">
                     <div class="row">
                         <div class="col-md-6">
                             <h5>Funcionalidad</h5>
                             <div class="mb-3">
                                <label class="form-label">Primer día de la semana:</label>
                                <div class="form-check">
                                  <input class="form-check-input" type="radio" name="startDayOfWeek" id="startDayMonday" value="1">
                                  <label class="form-check-label" for="startDayMonday">Lunes</label>
                                </div>
                                <div class="form-check">
                                  <input class="form-check-input" type="radio" name="startDayOfWeek" id="startDaySunday" value="0">
                                  <label class="form-check-label" for="startDaySunday">Domingo</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                  <input class="form-check-input" type="checkbox" role="switch" id="highlightWeekends">
                                  <label class="form-check-label" for="highlightWeekends">Resaltar fines de semana</label>
                                </div>
                            </div>
                         </div>
                         <div class="col-md-6">
                            <h5>Apariencia</h5>
                             <div class="mb-3">
                                 <label for="theme-select" class="form-label">Tema:</label>
                                 <select id="theme-select" class="form-select">
                                     <option value="contrast">Alto Contraste (Predeterminado)</option>
                                     <option value="default">Claro</option>
                                     <option value="pastel-rose">Pastel Rosa Suave</option>
                                     <option value="pastel-mint">Menta Fresca</option>
                                     <option value="serene-sky">Cielo Sereno</option>
                                     <option value="soft-lavender">Lavanda Suave</option>
                                     <option value="peach-dream">Sueño de Melocotón</option>
                                     <option value="lemon-zest">Ralladura de Limón</option>
                                     <option value="aqua-mist">Niebla Aqua</option>
                                     <option value="coral-blush">Rubor Coral</option>
                                     <option value="spring-meadow">Prado Primaveral</option>
                                     <option value="sandstone">Arenisca</option>
                                 </select>
                             </div>
                             <div class="mb-3">
                                <label for="line-thickness-slider" class="form-label">Grosor de Línea: <span id="line-thickness-value">1.5</span>px</label>
                                <input type="range" class="form-range" id="line-thickness-slider" min="0.5" max="3" step="0.1" value="1.5">
                            </div>
                            <div class="mb-3">
                                <label for="font-family-select" class="form-label">Fuente:</label>
                                <select id="font-family-select" class="form-select">
                                    <option value="'Lato', sans-serif">Lato (Predeterminada)</option>
                                    <option value="'Roboto', sans-serif">Roboto</option>
                                    <option value="'Montserrat', sans-serif">Montserrat</option>
                                    <option value="serif">Serif (Navegador)</option>
                                    <option value="monospace">Monospace (Navegador)</option>
                                </select>
                            </div>
                         </div>
                     </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="save-settings-button">Guardar y Aplicar</button>
                  </div>
                </div>
              </div>
            </div>

            <section id="calendar-output" class="calendar-section-wrapper calendar-section">
                <h2 id="calendar-title" class="text-center mb-3 d-print-none"></h2>
                <div class="table-responsive">
                     <table class="table table-bordered calendar-table">
                        <thead><tr></tr></thead>
                        <tbody id="calendar-body"></tbody>
                    </table>
                </div>
            </section>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const navLinks = document.querySelectorAll('.navbar .nav-link[data-view]');
            const viewWrappers = document.querySelectorAll('.view-wrapper');
            const generalPrintBtn = document.getElementById('general-print-btn');
            const pageTitleElement = document.getElementById('page-title');
            const monthlyAnnotationToolbarWrapper = document.getElementById('monthly-annotation-toolbar-wrapper');
            const annualAnnotationToolbarWrapper = document.getElementById('annual-annotation-toolbar-wrapper');

            let currentView = 'annual'; 
            let activeTool = null; 
            let annotations = {}; 
            let shiftSelectionAnchor = null; // Para selección de rango con Shift {year, month, day, view}

            let monthlyToolSettings = {
                pencil: { 
                    font: "'Lato', sans-serif", size: "12px", color: "#000000",
                    bold: false, italic: false, textAlign: "left", 
                    textAlignVertical: "flex-start" // flex-start, center, flex-end
                },
                marker: { type: "V", color: "green" },
                bgColor: { color: "#FFFF00" }
            };
            let annualToolSettings = {
                // Pencil no se usa en anual, pero se mantiene la estructura
                pencil: { font: "'Lato', sans-serif", size: "10px", color: "#333333", bold: false, italic: false, textAlign: "left", textAlignVertical: "flex-start" },
                marker: { type: "V", color: "#DC3545" }, 
                bgColor: { color: "#ADD8E6" }  
            };
            let activeToolSettings = annualToolSettings; 

            const ANNOTATIONS_STORAGE_KEY = 'calendarAnnotationsV1';
            const ANNUAL_SETTINGS_STORAGE_KEY = 'annualCalendarSettingsV1';
            const MONTHLY_SETTINGS_STORAGE_KEY = 'calendarSettingsV3';

            function loadAnnotations() { const storedAnnotations = localStorage.getItem(ANNOTATIONS_STORAGE_KEY); if (storedAnnotations) { try { annotations = JSON.parse(storedAnnotations); } catch (e) { annotations = {}; } } else { annotations = {}; } }
            function saveAnnotations() { try { localStorage.setItem(ANNOTATIONS_STORAGE_KEY, JSON.stringify(annotations)); } catch (e) { console.error("Error al guardar anotaciones:", e); } }
            function getAnnotationKey(year, month, day) { return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; }

            function generateToolbarHTML(settings, idPrefix = '') {
                const fonts = [ { name: "Lato", value: "'Lato', sans-serif" }, { name: "Roboto", value: "'Roboto', sans-serif" }, { name: "Montserrat", value: "'Montserrat', sans-serif" }, { name: "Arial", value: "Arial, sans-serif" }, { name: "Verdana", value: "Verdana, sans-serif" }, { name: "Times New Roman", value: "'Times New Roman', Times, serif" }, { name: "Courier New", value: "'Courier New', Courier, monospace" } ];
                const fontSizes = ["8px", "10px", "12px", "14px", "16px", "18px", "20px"];
                const markColors = [ { name: "Verde", value: "green" }, { name: "Rojo", value: "red" }, { name: "Azul", value: "blue" }, { name: "Naranja", value: "orange" }, { name: "Morado", value: "purple" }, { name: "Negro", value: "black" } ];
                const bgPalette = [ "#FFFFE0", "#ADD8E6", "#90EE90", "#FFB6C1", "#FFA07A", "#DDA0DD", "#F0E68C", "#FFFFFF", "#C0C0C0" ];

                // Opciones de formato de texto solo para la barra de herramientas mensual (idPrefix === '')
                const textFormatOptionsHTML = idPrefix === '' ? `
                    <div class="btn-group btn-group-sm mt-1" role="group" aria-label="Estilo de texto">
                        <button type="button" class="btn btn-outline-secondary ${settings.pencil.bold ? 'active' : ''}" data-format="bold" title="Negrita"><i class="bi bi-type-bold"></i></button>
                        <button type="button" class="btn btn-outline-secondary ${settings.pencil.italic ? 'active' : ''}" data-format="italic" title="Cursiva"><i class="bi bi-type-italic"></i></button>
                    </div>
                    <div class="btn-group btn-group-sm mt-1 ms-1" role="group" aria-label="Alineación Horizontal">
                        <button type="button" class="btn btn-outline-secondary ${settings.pencil.textAlign === 'left' ? 'active' : ''}" data-align="left" title="Alinear Izquierda"><i class="bi bi-text-left"></i></button>
                        <button type="button" class="btn btn-outline-secondary ${settings.pencil.textAlign === 'center' ? 'active' : ''}" data-align="center" title="Alinear Centro"><i class="bi bi-text-center"></i></button>
                        <button type="button" class="btn btn-outline-secondary ${settings.pencil.textAlign === 'right' ? 'active' : ''}" data-align="right" title="Alinear Derecha"><i class="bi bi-text-right"></i></button>
                    </div>
                    <div class="btn-group btn-group-sm mt-1 ms-1" role="group" aria-label="Alineación Vertical">
                        <button type="button" class="btn btn-outline-secondary ${settings.pencil.textAlignVertical === 'flex-start' ? 'active' : ''}" data-valign="flex-start" title="Alinear Arriba"><i class="bi bi-align-top"></i></button>
                        <button type="button" class="btn btn-outline-secondary ${settings.pencil.textAlignVertical === 'center' ? 'active' : ''}" data-valign="center" title="Alinear Medio"><i class="bi bi-align-middle"></i></button>
                        <button type="button" class="btn btn-outline-secondary ${settings.pencil.textAlignVertical === 'flex-end' ? 'active' : ''}" data-valign="flex-end" title="Alinear Abajo"><i class="bi bi-align-bottom"></i></button>
                    </div>
                ` : '';

                return `
                    <div class="annotation-toolbar">
                        <div class="tool-group">
                            <div class="btn-group" role="group" aria-label="Herramientas de anotación">
                                <button type="button" class="btn btn-outline-secondary" data-tool="cursor" title="Cursor"><i class="bi bi-mouse-fill"></i></button>
                                <button type="button" class="btn btn-outline-secondary" data-tool="pencil" title="Lápiz"><i class="bi bi-pencil-fill"></i></button>
                                <button type="button" class="btn btn-outline-secondary" data-tool="marker" title="Marcas"><i class="bi bi-check2-square"></i></button>
                                <button type="button" class="btn btn-outline-secondary" data-tool="bgColor" title="Fondo"><i class="bi bi-palette-fill"></i></button>
                            </div>
                        </div>
                        <div class="tool-options" data-tool-options="pencil">
                            <label for="${idPrefix}pencil-font-select">Fuente:</label>
                            <select id="${idPrefix}pencil-font-select" class="form-select form-select-sm">${fonts.map(f => `<option value="${f.value}" ${f.value === settings.pencil.font ? 'selected' : ''}>${f.name}</option>`).join('')}</select>
                            <label for="${idPrefix}pencil-size-select">Tamaño:</label>
                            <select id="${idPrefix}pencil-size-select" class="form-select form-select-sm">${fontSizes.map(s => `<option value="${s}" ${s === settings.pencil.size ? 'selected' : ''}>${s}</option>`).join('')}</select>
                            <label for="${idPrefix}pencil-color-input">Color:</label>
                            <input type="color" id="${idPrefix}pencil-color-input" class="form-control form-control-sm form-control-color" value="${settings.pencil.color}" title="Color texto">
                            ${textFormatOptionsHTML}
                        </div>
                        <div class="tool-options" data-tool-options="marker">
                            <label>Tipo:</label>
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="${idPrefix}marker-type" id="${idPrefix}marker-v" value="V" ${settings.marker.type === 'V' ? 'checked' : ''}><label class="btn btn-outline-primary" for="${idPrefix}marker-v"><i class="bi bi-check-lg"></i></label>
                                <input type="radio" class="btn-check" name="${idPrefix}marker-type" id="${idPrefix}marker-x" value="X" ${settings.marker.type === 'X' ? 'checked' : ''}><label class="btn btn-outline-primary" for="${idPrefix}marker-x"><i class="bi bi-x-lg"></i></label>
                            </div>
                            <label for="${idPrefix}marker-color-select">Color:</label>
                            <select id="${idPrefix}marker-color-select" class="form-select form-select-sm">${markColors.map(c => `<option value="${c.value}" ${c.value === settings.marker.color ? 'selected' : ''}>${c.name}</option>`).join('')}</select>
                        </div>
                        <div class="tool-options" data-tool-options="bgColor">
                            <label>Color:</label>
                            <div class="color-palette d-flex align-items-center">${bgPalette.map(color => `<button type="button" class="color-palette-btn ${settings.bgColor.color === color ? 'active' : ''}" data-color="${color}" style="background-color: ${color};" title="${color}"></button>`).join('')}
                                <input type="color" id="${idPrefix}bgColor-custom-input" class="form-control form-control-sm form-control-color ms-2" value="${settings.bgColor.color}" title="Color personalizado">
                            </div>
                        </div>
                    </div>`;
            }

            function initializeToolbars() { if (monthlyAnnotationToolbarWrapper) monthlyAnnotationToolbarWrapper.innerHTML = generateToolbarHTML(monthlyToolSettings, ''); if (annualAnnotationToolbarWrapper) annualAnnotationToolbarWrapper.innerHTML = generateToolbarHTML(annualToolSettings, 'annual-'); setupToolbarListeners(); }
            
            function setupToolbarListeners() {
                document.querySelectorAll('.annotation-toolbar').forEach(toolbar => {
                    const isMonthly = toolbar.closest('#monthly-annotation-toolbar-wrapper') !== null;
                    const currentSettings = isMonthly ? monthlyToolSettings : annualToolSettings;
                    const prefix = isMonthly ? '' : 'annual-';

                    toolbar.addEventListener('click', e => {
                        const toolBtn = e.target.closest('button[data-tool]');
                        if (toolBtn) { const tool = toolBtn.dataset.tool; if (!isMonthly && tool === 'pencil') { setActiveTool(null, toolbar); return; } setActiveTool(tool === 'cursor' ? null : tool, toolbar); }
                        
                        const paletteBtn = e.target.closest('.color-palette-btn[data-color]');
                        if (paletteBtn && activeTool === 'bgColor') { currentSettings.bgColor.color = paletteBtn.dataset.color; toolbar.querySelectorAll('.color-palette-btn.active').forEach(b => b.classList.remove('active')); paletteBtn.classList.add('active'); const customColorInput = toolbar.querySelector(`#${prefix}bgColor-custom-input`); if (customColorInput) customColorInput.value = currentSettings.bgColor.color; }

                        if (isMonthly && activeTool === 'pencil') {
                            const formatBtn = e.target.closest('button[data-format]');
                            if (formatBtn) { const type = formatBtn.dataset.format; if (type === 'bold' || type === 'italic') { currentSettings.pencil[type] = !currentSettings.pencil[type]; formatBtn.classList.toggle('active'); } }
                            const alignBtn = e.target.closest('button[data-align]');
                            if (alignBtn) { currentSettings.pencil.textAlign = alignBtn.dataset.align; toolbar.querySelectorAll('button[data-align].active').forEach(b => b.classList.remove('active')); alignBtn.classList.add('active'); }
                            const valignBtn = e.target.closest('button[data-valign]');
                            if (valignBtn) { currentSettings.pencil.textAlignVertical = valignBtn.dataset.valign; toolbar.querySelectorAll('button[data-valign].active').forEach(b => b.classList.remove('active')); valignBtn.classList.add('active'); }
                        }
                    });
                    const pencilFont = toolbar.querySelector(`#${prefix}pencil-font-select`); if (pencilFont) pencilFont.onchange = e => currentSettings.pencil.font = e.target.value;
                    const pencilSize = toolbar.querySelector(`#${prefix}pencil-size-select`); if (pencilSize) pencilSize.onchange = e => currentSettings.pencil.size = e.target.value;
                    const pencilColor = toolbar.querySelector(`#${prefix}pencil-color-input`); if (pencilColor) pencilColor.oninput = e => currentSettings.pencil.color = e.target.value;
                    toolbar.querySelectorAll(`input[name="${prefix}marker-type"]`).forEach(r => r.onchange = e => currentSettings.marker.type = e.target.value);
                    const markerColor = toolbar.querySelector(`#${prefix}marker-color-select`); if (markerColor) markerColor.onchange = e => currentSettings.marker.color = e.target.value;
                    const bgColorInput = toolbar.querySelector(`#${prefix}bgColor-custom-input`); if (bgColorInput) bgColorInput.oninput = e => { currentSettings.bgColor.color = e.target.value; toolbar.querySelectorAll('.color-palette-btn.active').forEach(b => b.classList.remove('active')); };
                });
            }

            function setActiveTool(toolName, toolbarCtx) { 
                activeTool = toolName; 
                if (currentView === 'annual' && activeTool === 'pencil') activeTool = null; // Lápiz no permitido en anual

                // Resetear ancla de selección si la herramienta no es para rango
                if (toolName !== 'marker' && toolName !== 'bgColor') {
                    shiftSelectionAnchor = null;
                }

                document.querySelectorAll('.annotation-toolbar').forEach(tb => { 
                    tb.querySelectorAll('button[data-tool]').forEach(btn => btn.classList.toggle('active', btn.dataset.tool === activeTool || (activeTool === null && btn.dataset.tool === 'cursor'))); 
                    tb.querySelectorAll('.tool-options').forEach(op => op.classList.toggle('active', op.dataset.toolOptions === activeTool)); 
                }); 
                let cursor = 'default'; 
                if (activeTool === 'pencil' && currentView === 'monthly') cursor = 'text'; 
                else if (activeTool === 'marker' || activeTool === 'bgColor') cursor = 'crosshair'; 
                const monthlyCalBody = document.getElementById('calendar-body'); 
                if (monthlyCalBody) { monthlyCalBody.style.cursor = cursor; monthlyCalBody.querySelectorAll('td:not(.empty-cell)').forEach(c => c.style.cursor = cursor); } 
                const annualCalCont = document.getElementById('annual-calendar-container'); 
                if (annualCalCont) { 
                    let annualCursor = 'default'; 
                    if (activeTool === 'marker' || activeTool === 'bgColor') annualCursor = 'crosshair'; 
                    annualCalCont.style.cursor = annualCursor; 
                    annualCalCont.querySelectorAll('.annual-day-cell').forEach(c => c.style.cursor = annualCursor); 
                } 
            }

            function setActiveView(viewName) { 
                currentView = viewName; 
                shiftSelectionAnchor = null; // Resetear ancla al cambiar de vista

                viewWrappers.forEach(w => w.classList.toggle('active', w.id === `${viewName}-view-wrapper`)); 
                navLinks.forEach(l => { 
                    const isAct = l.dataset.view === viewName; 
                    l.classList.toggle('active', isAct); 
                    if (isAct) l.setAttribute('aria-current', 'page'); 
                    else l.removeAttribute('aria-current'); 
                }); 
                let currentToolbar = null; 
                if (viewName === 'annual') { 
                    activeToolSettings = annualToolSettings; 
                    pageTitleElement.textContent = annualViewLogic.getCurrentTitle() || 'Calendario Anual'; 
                    if (annualAnnotationToolbarWrapper) { annualAnnotationToolbarWrapper.style.display = 'block'; currentToolbar = annualAnnotationToolbarWrapper.querySelector('.annotation-toolbar'); } 
                    if (monthlyAnnotationToolbarWrapper) monthlyAnnotationToolbarWrapper.style.display = 'none'; 
                    if (activeTool === 'pencil') setActiveTool(null, currentToolbar); // Desactivar lápiz si estaba activo
                    else setActiveTool(activeTool, currentToolbar); 
                } else if (viewName === 'monthly') { 
                    activeToolSettings = monthlyToolSettings; 
                    pageTitleElement.textContent = monthlyViewLogic?.getCurrentSettings()?.mainTitle || 'Calendario Mensual'; 
                    if (monthlyAnnotationToolbarWrapper) { monthlyAnnotationToolbarWrapper.style.display = 'block'; currentToolbar = monthlyAnnotationToolbarWrapper.querySelector('.annotation-toolbar'); } 
                    if (annualAnnotationToolbarWrapper) annualAnnotationToolbarWrapper.style.display = 'none'; 
                    setActiveTool(activeTool, currentToolbar); 
                } else { 
                    pageTitleElement.textContent = 'Calendarios'; 
                    if (monthlyAnnotationToolbarWrapper) monthlyAnnotationToolbarWrapper.style.display = 'none'; 
                    if (annualAnnotationToolbarWrapper) annualAnnotationToolbarWrapper.style.display = 'none'; 
                } 
            }
            navLinks.forEach(l => l.onclick = e => { e.preventDefault(); const v = e.target.dataset.view; if (v) setActiveView(v); });
            if (generalPrintBtn) generalPrintBtn.onclick = () => window.print();

            const annualViewLogic = (() => {
                const wrapper = document.getElementById('annual-view-wrapper');
                if (!wrapper) return { init: () => {}, getCurrentTitle: () => "Calendario Anual", generateRequiredCalendars: () => {} };
                const calendarContainer = wrapper.querySelector('#annual-calendar-container');
                const mainTitleElement = wrapper.querySelector('#annual-main-title');
                const yearRangeDisplayElement = wrapper.querySelector('#calendar-year-range-display');
                const viewSubtitleElement = wrapper.querySelector('#calendar-view-subtitle');
                const yearSelect = wrapper.querySelector('#annual-year-select');
                const viewRadios = wrapper.querySelectorAll('input[name="viewSelectionAnnual"]');
                const schoolYearRadio = wrapper.querySelector('#viewSchoolYear');
                const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                const dayHeaders = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
                let currentAnnualSettings = { title: "Calendario Anual", startYear: new Date().getFullYear(), viewType: "school" };
                function loadAnnualSettings() { const stored = localStorage.getItem(ANNUAL_SETTINGS_STORAGE_KEY); if (stored) try { currentAnnualSettings = { ...currentAnnualSettings, ...JSON.parse(stored) }; } catch (e) {} }
                function saveAnnualSettings() { currentAnnualSettings.startYear = parseInt(yearSelect.value, 10); currentAnnualSettings.viewType = wrapper.querySelector('input[name="viewSelectionAnnual"]:checked')?.value || 'school'; try { localStorage.setItem(ANNUAL_SETTINGS_STORAGE_KEY, JSON.stringify(currentAnnualSettings)); } catch (e) {} }
                function createMonthHTML(year, monthIndex) { const daysInMonth = new Date(year, monthIndex + 1, 0).getDate(); const firstDayDateObj = new Date(year, monthIndex, 1); const startDayOfWeek = (firstDayDateObj.getDay() + 6) % 7; let tableHTML = `<div class="col-lg-4 col-md-4 col-sm-6 month-container" data-month="${monthIndex}" data-year="${year}"><h3 class="month-name">${monthNames[monthIndex]}</h3><table class="calendar-table"><thead><tr>`; dayHeaders.forEach(h => { tableHTML += `<th>${h}</th>`; }); tableHTML += `</tr></thead><tbody><tr>`; let dayCounter = 1; let cellCounter = 0; for (let i = 0; i < startDayOfWeek; i++) { tableHTML += `<td class="empty-day"></td>`; cellCounter++; } while (dayCounter <= daysInMonth) { if (cellCounter > 0 && cellCounter % 7 === 0) tableHTML += `</tr><tr>`; const dayDate = new Date(year, monthIndex, dayCounter); const dayOfWeek = (dayDate.getDay() + 6) % 7; let cellClasses = 'annual-day-cell'; if (dayOfWeek === 5 || dayOfWeek === 6) cellClasses += ' annual-weekend-day'; const annotationKey = getAnnotationKey(year, monthIndex, dayCounter); const dayAnnotation = annotations[annotationKey] || {}; tableHTML += `<td class="${cellClasses}" data-day="${dayCounter}"><span>${dayCounter}</span><div class="annual-day-annotations-wrapper">`; if (dayAnnotation.bgColor) tableHTML += `<div class="annual-day-bg-highlight" style="background-color: ${dayAnnotation.bgColor} !important;"></div>`; if (dayAnnotation.mark) tableHTML += `<span class="day-mark-symbol" style="color: ${dayAnnotation.mark.color};">${dayAnnotation.mark.type === 'V' ? '✓' : '✕'}</span>`; tableHTML += `</div></td>`; dayCounter++; cellCounter++; } while (cellCounter % 7 !== 0) { tableHTML += `<td class="empty-day"></td>`; cellCounter++; } tableHTML += `</tr></tbody></table></div>`; return tableHTML; }
                function updateDynamicTitles(baseYear, view) { if (!yearRangeDisplayElement || !viewSubtitleElement) return; if (view === 'school') { yearRangeDisplayElement.textContent = `${baseYear} - ${baseYear + 1}`; viewSubtitleElement.textContent = 'Año Escolar (Septiembre - Junio)'; } else { yearRangeDisplayElement.textContent = baseYear; viewSubtitleElement.textContent = 'Año Completo (Enero - Diciembre)'; } }
                function updateVisibleMonthsAndTitle() { const selectedView = currentAnnualSettings.viewType; const baseYear = currentAnnualSettings.startYear; if (isNaN(baseYear)) return; const nextYear = baseYear + 1; const allMonths = calendarContainer.querySelectorAll('.month-container'); updateDynamicTitles(baseYear, selectedView); const schoolYearMonthsBase = [8, 9, 10, 11]; const schoolYearMonthsNext = [0, 1, 2, 3, 4, 5]; let hasVisibleMonths = false; allMonths.forEach(monthDiv => { const monthIndex = parseInt(monthDiv.dataset.month, 10); const monthYear = parseInt(monthDiv.dataset.year, 10); let isVisible = (selectedView === 'full' && monthYear === baseYear) || (selectedView === 'school' && ((monthYear === baseYear && schoolYearMonthsBase.includes(monthIndex)) || (monthYear === nextYear && schoolYearMonthsNext.includes(monthIndex)))); monthDiv.classList.toggle('visible', isVisible); if (isVisible) hasVisibleMonths = true; const monthNameElement = monthDiv.querySelector('.month-name'); if (monthNameElement) { const existingSuffix = monthNameElement.querySelector('.year-suffix'); if (existingSuffix) existingSuffix.remove(); if (isVisible && selectedView === 'school' && monthYear === nextYear && schoolYearMonthsNext.includes(monthIndex)) monthNameElement.insertAdjacentHTML('beforeend', `<span class="year-suffix">(${nextYear})</span>`); else if (isVisible && selectedView === 'school' && monthYear === baseYear && schoolYearMonthsBase.includes(monthIndex)) monthNameElement.insertAdjacentHTML('beforeend', `<span class="year-suffix">(${baseYear})</span>`); else if (isVisible && selectedView === 'full') monthNameElement.insertAdjacentHTML('beforeend', `<span class="year-suffix">(${baseYear})</span>`); } }); calendarContainer.style.display = hasVisibleMonths ? 'flex' : 'none'; }
                function generateRequiredCalendars() { const baseYear = parseInt(yearSelect.value, 10); if (isNaN(baseYear) || baseYear < 1000 || baseYear > 3000) { alert("Año inválido."); yearSelect.value = new Date().getFullYear(); generateRequiredCalendars(); return; } currentAnnualSettings.startYear = baseYear; calendarContainer.innerHTML = ''; let fullCalendarHTML = ''; for (let i = 0; i < 12; i++) fullCalendarHTML += createMonthHTML(baseYear, i); for (let i = 0; i < 12; i++) fullCalendarHTML += createMonthHTML(baseYear + 1, i); calendarContainer.innerHTML = fullCalendarHTML; updateVisibleMonthsAndTitle(); saveAnnualSettings(); }
                function handleTitleEdit(event) { const newTitle = event.target.textContent.trim(); currentAnnualSettings.title = newTitle || "Calendario Anual"; event.target.textContent = currentAnnualSettings.title; if (currentView === 'annual') pageTitleElement.textContent = currentAnnualSettings.title; saveAnnualSettings(); }
                
                function handleAnnualCellClick(event) {
                    const cell = event.target.closest('.annual-day-cell:not(.empty-day)');
                    if (!cell) return;

                    const day = parseInt(cell.dataset.day, 10);
                    const monthContainer = cell.closest('.month-container');
                    const month = parseInt(monthContainer.dataset.month, 10);
                    const year = parseInt(monthContainer.dataset.year, 10);

                    const isRangeToolActive = activeTool && (activeTool === 'marker' || activeTool === 'bgColor');
                    if (activeTool === 'pencil') return; // Lápiz no se usa en anual

                    if (event.shiftKey && shiftSelectionAnchor && shiftSelectionAnchor.view === 'annual' && isRangeToolActive) {
                        const start = new Date(shiftSelectionAnchor.year, shiftSelectionAnchor.month, shiftSelectionAnchor.day);
                        const end = new Date(year, month, day);

                        const loopStartDate = start <= end ? new Date(start.getFullYear(), start.getMonth(), start.getDate()) : new Date(end.getFullYear(), end.getMonth(), end.getDate());
                        const loopEndDate = start <= end ? new Date(end.getFullYear(), end.getMonth(), end.getDate()) : new Date(start.getFullYear(), start.getMonth(), start.getDate());
                        
                        let iterDate = new Date(loopStartDate);
                        let changedKeysForDomUpdate = [];

                        while (iterDate.getTime() <= loopEndDate.getTime()) {
                            const currentIterYear = iterDate.getFullYear();
                            const currentIterMonth = iterDate.getMonth();
                            const currentIterDay = iterDate.getDate();
                            const key = getAnnotationKey(currentIterYear, currentIterMonth, currentIterDay);
                            
                            annotations[key] = annotations[key] || {};
                            if (activeTool === 'marker') {
                                annotations[key].mark = { ...activeToolSettings.marker };
                            } else if (activeTool === 'bgColor') {
                                annotations[key].bgColor = activeToolSettings.bgColor.color;
                            }
                            changedKeysForDomUpdate.push(key);
                            iterDate.setDate(iterDate.getDate() + 1);
                        }
                        saveAnnotations();

                        changedKeysForDomUpdate.forEach(keyToUpdate => {
                            const [y, m, d] = keyToUpdate.split('-').map(Number);
                            const mContainer = document.querySelector(`#annual-calendar-container .month-container[data-year="${y}"][data-month="${m-1}"]`);
                            if (mContainer && mContainer.classList.contains('visible')) { // Solo actualizar si el mes es visible
                                const dayCell = mContainer.querySelector(`.annual-day-cell[data-day="${d}"]`);
                                if (dayCell) {
                                    const annWrapper = dayCell.querySelector('.annual-day-annotations-wrapper');
                                    if (annWrapper) {
                                        annWrapper.innerHTML = '';
                                        if (annotations[keyToUpdate].bgColor) {
                                            annWrapper.innerHTML += `<div class="annual-day-bg-highlight" style="background-color: ${annotations[keyToUpdate].bgColor} !important;"></div>`;
                                        }
                                        if (annotations[keyToUpdate].mark) {
                                            annWrapper.innerHTML += `<span class="day-mark-symbol" style="color: ${annotations[keyToUpdate].mark.color};">${annotations[keyToUpdate].mark.type === 'V' ? '✓' : '✕'}</span>`;
                                        }
                                    }
                                }
                            }
                        });
                    } else { // Clic único o herramienta no de rango o sin ancla válida
                        if (isRangeToolActive) {
                            shiftSelectionAnchor = { year, month, day, view: 'annual' };
                        } else if (!activeTool) { // Cursor
                            shiftSelectionAnchor = null;
                        }
                        
                        if (!isRangeToolActive) return; // Si no es marker o bgColor (ej. cursor), no hay acción individual aquí

                        const annotationKey = getAnnotationKey(year, month, day);
                        annotations[annotationKey] = annotations[annotationKey] || {};
                        let cellNeedsDomUpdate = false;

                        if (activeTool === 'marker') {
                            if (annotations[annotationKey].mark && annotations[annotationKey].mark.type === activeToolSettings.marker.type && annotations[annotationKey].mark.color === activeToolSettings.marker.color) {
                                delete annotations[annotationKey].mark;
                            } else {
                                annotations[annotationKey].mark = { ...activeToolSettings.marker };
                            }
                            cellNeedsDomUpdate = true;
                        } else if (activeTool === 'bgColor') {
                            if (annotations[annotationKey].bgColor === activeToolSettings.bgColor.color) {
                                delete annotations[annotationKey].bgColor;
                            } else {
                                annotations[annotationKey].bgColor = activeToolSettings.bgColor.color;
                            }
                            cellNeedsDomUpdate = true;
                        }

                        if (cellNeedsDomUpdate) {
                            saveAnnotations();
                            const annotationsWrapper = cell.querySelector('.annual-day-annotations-wrapper');
                            if (annotationsWrapper) {
                                annotationsWrapper.innerHTML = '';
                                if (annotations[annotationKey].bgColor) annotationsWrapper.innerHTML += `<div class="annual-day-bg-highlight" style="background-color: ${annotations[annotationKey].bgColor} !important;"></div>`;
                                if (annotations[annotationKey].mark) annotationsWrapper.innerHTML += `<span class="day-mark-symbol" style="color: ${annotations[annotationKey].mark.color};">${annotations[annotationKey].mark.type === 'V' ? '✓' : '✕'}</span>`;
                            }
                        }
                    }
                }

                function init() { loadAnnualSettings(); loadAnnotations(); yearSelect.value = currentAnnualSettings.startYear; const currentViewTypeRadio = wrapper.querySelector(`input[name="viewSelectionAnnual"][value="${currentAnnualSettings.viewType}"]`); if (currentViewTypeRadio) currentViewTypeRadio.checked = true; else if (schoolYearRadio) schoolYearRadio.checked = true; if (mainTitleElement) mainTitleElement.textContent = currentAnnualSettings.title; yearSelect.onchange = generateRequiredCalendars; viewRadios.forEach(radio => radio.onchange = () => { currentAnnualSettings.viewType = radio.value; updateVisibleMonthsAndTitle(); saveAnnualSettings(); }); if (mainTitleElement) { mainTitleElement.onblur = handleTitleEdit; mainTitleElement.onkeypress = e => { if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); } }; } calendarContainer.onclick = handleAnnualCellClick; generateRequiredCalendars(); }
                return { init, getCurrentTitle: () => currentAnnualSettings.title, generateRequiredCalendars };
            })();

             const monthlyViewLogic = (() => {
                const wrapper = document.getElementById('monthly-view-wrapper'); if (!wrapper) return { init: () => {}, getCurrentSettings: () => null, generateCalendar: () => {} };
                const mainTitleElement = wrapper.querySelector('#monthly-main-title'); const monthSelect = wrapper.querySelector('#monthly-month-select'); const yearSelect = wrapper.querySelector('#monthly-year-select'); const calendarBody = wrapper.querySelector('#calendar-body'); const calendarTitle = wrapper.querySelector('#calendar-title'); const calendarTableHead = wrapper.querySelector('.calendar-table thead tr'); const settingsModalElement = document.getElementById('settingsModal'); const settingsModal = settingsModalElement ? new bootstrap.Modal(settingsModalElement) : null; const saveSettingsButton = document.getElementById('save-settings-button'); const startDayMondayRadio = document.getElementById('startDayMonday'); const startDaySundayRadio = document.getElementById('startDaySunday'); const highlightWeekendsSwitch = document.getElementById('highlightWeekends'); const themeSelect = document.getElementById('theme-select'); const lineThicknessSlider = document.getElementById('line-thickness-slider'); const lineThicknessValueSpan = document.getElementById('line-thickness-value'); const fontFamilySelect = document.getElementById('font-family-select'); const bodyElement = document.body; const rootElement = document.documentElement;
                const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]; const dayNamesShort = { mondayFirst: ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"], sundayFirst: ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"] }; const defaultSettings = { mainTitle: "Calendario Mensual", startDayOfWeek: 1, highlightWeekends: true, theme: 'contrast', lineWidth: 1.5, fontFamily: "'Lato', sans-serif", currentMonth: new Date().getMonth(), currentYear: new Date().getFullYear() }; let currentSettings = { ...defaultSettings };
                function applyTheme(themeValue) { const allThemeValues = ['contrast', 'default', 'pastel-rose', 'pastel-mint', 'serene-sky', 'soft-lavender', 'peach-dream', 'lemon-zest', 'aqua-mist', 'coral-blush', 'spring-meadow', 'sandstone']; const allThemeClasses = allThemeValues.map(val => `theme-${val}`); bodyElement.classList.remove(...allThemeClasses); const validThemeValue = allThemeValues.includes(themeValue) ? themeValue : defaultSettings.theme; bodyElement.classList.add(`theme-${validThemeValue}`); currentSettings.theme = validThemeValue; }
                function applyLineThickness(width) { const widthValue = parseFloat(width).toFixed(1); rootElement.style.setProperty('--calendar-border-width', `${widthValue}px`); if (lineThicknessValueSpan) lineThicknessValueSpan.textContent = widthValue; currentSettings.lineWidth = widthValue; }
                function applyFontFamily(font) { const safeFont = font || defaultSettings.fontFamily; rootElement.style.setProperty('--calendar-font-family', safeFont); currentSettings.fontFamily = safeFont; }
                function applyMainTitle(title) { const safeTitle = title ? title.trim() : defaultSettings.mainTitle; const finalTitle = safeTitle || defaultSettings.mainTitle; if (mainTitleElement) mainTitleElement.textContent = finalTitle; if (currentView === 'monthly') pageTitleElement.textContent = finalTitle; currentSettings.mainTitle = finalTitle; }
                function loadMonthlySettings() { try { const storedSettings = localStorage.getItem(MONTHLY_SETTINGS_STORAGE_KEY); if (storedSettings) currentSettings = { ...defaultSettings, ...JSON.parse(storedSettings) }; } catch (error) {} applyMainTitle(currentSettings.mainTitle); if (startDayMondayRadio) startDayMondayRadio.checked = currentSettings.startDayOfWeek === 1; if (startDaySundayRadio) startDaySundayRadio.checked = currentSettings.startDayOfWeek === 0; if (highlightWeekendsSwitch) highlightWeekendsSwitch.checked = currentSettings.highlightWeekends; if (themeSelect) themeSelect.value = currentSettings.theme; if (lineThicknessSlider) lineThicknessSlider.value = currentSettings.lineWidth; if (fontFamilySelect) fontFamilySelect.value = currentSettings.fontFamily; applyTheme(currentSettings.theme); applyLineThickness(currentSettings.lineWidth); applyFontFamily(currentSettings.fontFamily); monthSelect.value = currentSettings.currentMonth; yearSelect.value = currentSettings.currentYear; }
                function saveMonthlySettingsToLocalStorage() { try { currentSettings.startDayOfWeek = parseInt(document.querySelector('input[name="startDayOfWeek"]:checked')?.value || defaultSettings.startDayOfWeek); currentSettings.highlightWeekends = highlightWeekendsSwitch ? highlightWeekendsSwitch.checked : defaultSettings.highlightWeekends; currentSettings.currentMonth = parseInt(monthSelect.value); currentSettings.currentYear = parseInt(yearSelect.value); localStorage.setItem(MONTHLY_SETTINGS_STORAGE_KEY, JSON.stringify(currentSettings)); } catch (error) {} }
                function handleSaveSettingsModalButtonClick() { currentSettings.startDayOfWeek = parseInt(document.querySelector('input[name="startDayOfWeek"]:checked')?.value || defaultSettings.startDayOfWeek); currentSettings.highlightWeekends = highlightWeekendsSwitch ? highlightWeekendsSwitch.checked : defaultSettings.highlightWeekends; saveMonthlySettingsToLocalStorage(); if (settingsModal) settingsModal.hide(); generateCalendar(currentSettings.currentYear, currentSettings.currentMonth); }
                function handleTitleEdit(event) { applyMainTitle(event.target.textContent); saveMonthlySettingsToLocalStorage(); }
                function populateYears() { const currentSelectedYear = parseInt(yearSelect.value) || new Date().getFullYear(); const startYear = currentSelectedYear - 10; const endYear = currentSelectedYear + 10; yearSelect.innerHTML = ''; for (let year = startYear; year <= endYear; year++) { const option = document.createElement('option'); option.value = year; option.textContent = year; yearSelect.appendChild(option); } yearSelect.value = currentSelectedYear; }
                
                function generateCalendar(year, month) {
                    if (isNaN(year) || isNaN(month) || month < 0 || month > 11) { calendarTitle.textContent = "Error"; calendarBody.innerHTML = '<tr><td colspan="7">Error.</td></tr>'; return; }
                    currentSettings.currentYear = year; currentSettings.currentMonth = month;
                    calendarBody.innerHTML = ''; calendarTableHead.innerHTML = '';
                    const { startDayOfWeek: startDaySetting, highlightWeekends } = currentSettings; const currentDayNames = startDaySetting === 1 ? dayNamesShort.mondayFirst : dayNamesShort.sundayFirst;
                    currentDayNames.forEach(day => { const th = document.createElement('th'); th.scope = 'col'; th.textContent = day; calendarTableHead.appendChild(th); });
                    const firstDayOfMonth = new Date(year, month, 1); const daysInMonth = new Date(year, month + 1, 0).getDate(); let firstDayIndex = startDaySetting === 1 ? (firstDayOfMonth.getDay() + 6) % 7 : firstDayOfMonth.getDay();
                    calendarTitle.textContent = `${monthNames[month]} ${year}`; let date = 1; let currentWeekRow = document.createElement('tr');
                    for (let i = 0; i < firstDayIndex; i++) { const emptyCell = document.createElement('td'); emptyCell.classList.add('empty-cell'); currentWeekRow.appendChild(emptyCell); }
                    while (date <= daysInMonth) {
                        if (currentWeekRow.children.length === 7) { calendarBody.appendChild(currentWeekRow); currentWeekRow = document.createElement('tr'); }
                        const cell = document.createElement('td'); cell.dataset.day = date; cell.dataset.month = month; cell.dataset.year = year;
                        const dayNumberSpan = document.createElement('span'); dayNumberSpan.classList.add('day-number'); dayNumberSpan.textContent = date;
                        const contentWrapper = document.createElement('div'); contentWrapper.classList.add('day-content-wrapper');
                        const annotationKey = getAnnotationKey(year, month, date); const dayAnnotation = annotations[annotationKey] || {};
                        
                        // Aplicar alineación vertical basada en anotación o por defecto de la herramienta
                        const verticalAlign = (dayAnnotation.text && dayAnnotation.text.textAlignVertical) ? 
                                              dayAnnotation.text.textAlignVertical : monthlyToolSettings.pencil.textAlignVertical;
                        contentWrapper.style.justifyContent = verticalAlign;

                        if (dayAnnotation.text) {
                            const textDiv = document.createElement('div'); textDiv.classList.add('day-annotation-text');
                            textDiv.textContent = dayAnnotation.text.contenido;
                            textDiv.style.fontFamily = dayAnnotation.text.fuente || monthlyToolSettings.pencil.font;
                            textDiv.style.fontSize = dayAnnotation.text.tamano || monthlyToolSettings.pencil.size;
                            textDiv.style.color = dayAnnotation.text.color || monthlyToolSettings.pencil.color;
                            textDiv.style.fontWeight = dayAnnotation.text.bold ? 'bold' : 'normal';
                            textDiv.style.fontStyle = dayAnnotation.text.italic ? 'italic' : 'normal';
                            textDiv.style.textAlign = dayAnnotation.text.textAlign || 'left';
                            contentWrapper.appendChild(textDiv);
                        }
                        if (dayAnnotation.mark) { const markSpan = document.createElement('span'); markSpan.classList.add('day-mark-symbol'); markSpan.textContent = dayAnnotation.mark.type === 'V' ? '✓' : '✕'; markSpan.style.color = dayAnnotation.mark.color; contentWrapper.appendChild(markSpan); }
                        if (dayAnnotation.bgColor) cell.style.setProperty('background-color', dayAnnotation.bgColor, 'important');
                        
                        cell.appendChild(dayNumberSpan); cell.appendChild(contentWrapper);
                        const currentDate = new Date(year, month, date); const dayOfWeek = currentDate.getDay();
                        if (highlightWeekends && !dayAnnotation.bgColor && ((startDaySetting === 1 && (dayOfWeek === 6 || dayOfWeek === 0)) || (startDaySetting === 0 && (dayOfWeek === 0 || dayOfWeek === 6)))) {
                            cell.classList.add('weekend-cell');
                        } else {
                            cell.classList.remove('weekend-cell');
                        }
                        currentWeekRow.appendChild(cell); date++;
                    }
                    while (currentWeekRow.children.length > 0 && currentWeekRow.children.length < 7) { const emptyCell = document.createElement('td'); emptyCell.classList.add('empty-cell'); currentWeekRow.appendChild(emptyCell); }
                    if (currentWeekRow.children.length > 0) calendarBody.appendChild(currentWeekRow);
                    saveMonthlySettingsToLocalStorage();
                }

                function handleMonthlyCellClick(event) {
                    const cell = event.target.closest('td:not(.empty-cell)');
                    if (!cell) return;

                    const day = parseInt(cell.dataset.day, 10);
                    const month = parseInt(cell.dataset.month, 10);
                    const year = parseInt(cell.dataset.year, 10);
                    const contentWrapper = cell.querySelector('.day-content-wrapper');
                    const isRangeToolActive = activeTool && (activeTool === 'marker' || activeTool === 'bgColor');

                    if (event.shiftKey && shiftSelectionAnchor && shiftSelectionAnchor.view === 'monthly' && isRangeToolActive) {
                        // Lógica de Selección de Rango (Shift + Clic)
                        const start = new Date(shiftSelectionAnchor.year, shiftSelectionAnchor.month, shiftSelectionAnchor.day);
                        const end = new Date(year, month, day);

                        const loopStartDate = start <= end ? new Date(start.getFullYear(), start.getMonth(), start.getDate()) : new Date(end.getFullYear(), end.getMonth(), end.getDate());
                        const loopEndDate = start <= end ? new Date(end.getFullYear(), end.getMonth(), end.getDate()) : new Date(start.getFullYear(), start.getMonth(), start.getDate());
                        
                        let iterDate = new Date(loopStartDate);

                        while (iterDate.getTime() <= loopEndDate.getTime()) {
                            // Solo aplicar si la fecha está dentro del mes actualmente visualizado
                            if (iterDate.getFullYear() === currentSettings.currentYear && iterDate.getMonth() === currentSettings.currentMonth) {
                                const dayToModify = iterDate.getDate();
                                const key = getAnnotationKey(currentSettings.currentYear, currentSettings.currentMonth, dayToModify);
                                annotations[key] = annotations[key] || {};

                                if (activeTool === 'marker') {
                                    annotations[key].mark = { ...activeToolSettings.marker };
                                } else if (activeTool === 'bgColor') {
                                    annotations[key].bgColor = activeToolSettings.bgColor.color;
                                }
                            }
                            iterDate.setDate(iterDate.getDate() + 1);
                        }
                        saveAnnotations();
                        generateCalendar(currentSettings.currentYear, currentSettings.currentMonth);
                        // No resetear ancla para permitir más Shift+clics desde el mismo ancla
                    } else {
                        // Lógica de Clic Único (o clic con herramienta no de rango)
                        if (isRangeToolActive) { // Clic normal con marker/bgColor: establece el ancla
                            shiftSelectionAnchor = { year, month, day, view: 'monthly' };
                        } else if (!activeTool || activeTool === 'pencil') { // Clic con cursor o lápiz
                            shiftSelectionAnchor = null; // Resetea ancla
                        }

                        const annotationKey = getAnnotationKey(year, month, day);
                        annotations[annotationKey] = annotations[annotationKey] || {};
                        let needsRedraw = false;

                        if (activeTool === 'pencil') {
                            let textDiv = cell.querySelector('.day-annotation-text');
                            if (!textDiv) { 
                                textDiv = document.createElement('div'); 
                                textDiv.classList.add('day-annotation-text'); 
                                // Asegurar que el nuevo textDiv se añade en el orden correcto si hay marcas
                                const existingMark = contentWrapper.querySelector('.day-mark-symbol');
                                if (existingMark) {
                                    contentWrapper.insertBefore(textDiv, existingMark);
                                } else {
                                    contentWrapper.appendChild(textDiv);
                                }
                            }
                            textDiv.contentEditable = "true";
                            textDiv.style.fontFamily = activeToolSettings.pencil.font; 
                            textDiv.style.fontSize = activeToolSettings.pencil.size; 
                            textDiv.style.color = activeToolSettings.pencil.color;
                            textDiv.style.fontWeight = activeToolSettings.pencil.bold ? 'bold' : 'normal'; 
                            textDiv.style.fontStyle = activeToolSettings.pencil.italic ? 'italic' : 'normal';
                            textDiv.style.textAlign = activeToolSettings.pencil.textAlign;
                            
                            if(contentWrapper) contentWrapper.style.justifyContent = activeToolSettings.pencil.textAlignVertical;
                            
                            textDiv.focus();
                            textDiv.onblur = () => {
                                textDiv.contentEditable = "false"; 
                                const content = textDiv.textContent.trim();
                                if (content) {
                                    annotations[annotationKey].text = {
                                        contenido: content, 
                                        fuente: activeToolSettings.pencil.font, 
                                        tamano: activeToolSettings.pencil.size, 
                                        color: activeToolSettings.pencil.color,
                                        bold: activeToolSettings.pencil.bold, 
                                        italic: activeToolSettings.pencil.italic, 
                                        textAlign: activeToolSettings.pencil.textAlign,
                                        textAlignVertical: activeToolSettings.pencil.textAlignVertical // Guardar alineación vertical
                                    };
                                } else { 
                                    delete annotations[annotationKey].text; 
                                    textDiv.remove(); 
                                }
                                saveAnnotations();
                                // No es necesario redibujar todo el calendario, solo el justify-content si cambió
                                if (contentWrapper && annotations[annotationKey].text) {
                                   contentWrapper.style.justifyContent = annotations[annotationKey].text.textAlignVertical;
                                } else if (contentWrapper) {
                                   contentWrapper.style.justifyContent = monthlyToolSettings.pencil.textAlignVertical; // Reset a default
                                }
                            };
                        } else if (activeTool === 'marker') { 
                            const currentMark = annotations[annotationKey].mark; 
                            if (currentMark && currentMark.type === activeToolSettings.marker.type && currentMark.color === activeToolSettings.marker.color) {
                                delete annotations[annotationKey].mark; 
                            } else {
                                annotations[annotationKey].mark = { ...activeToolSettings.marker }; 
                            }
                            needsRedraw = true;
                        } else if (activeTool === 'bgColor') { 
                            if (annotations[annotationKey].bgColor === activeToolSettings.bgColor.color) { 
                                delete annotations[annotationKey].bgColor; 
                            } else { 
                                annotations[annotationKey].bgColor = activeToolSettings.bgColor.color; 
                            } 
                            needsRedraw = true; // Siempre redibujar para bgColor para actualizar el estilo de la celda.
                        }
                        
                        if (needsRedraw) { 
                            saveAnnotations(); 
                            generateCalendar(year, month); 
                        }
                    }
                }
                
                function init() { loadMonthlySettings(); loadAnnotations(); populateYears(); generateCalendar(currentSettings.currentYear, currentSettings.currentMonth); monthSelect.onchange = () => generateCalendar(parseInt(yearSelect.value), parseInt(monthSelect.value)); yearSelect.onchange = () => { populateYears(); generateCalendar(parseInt(yearSelect.value), parseInt(monthSelect.value)); }; if (mainTitleElement) { mainTitleElement.onblur = handleTitleEdit; mainTitleElement.onkeypress = e => { if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); } }; } if (themeSelect) themeSelect.onchange = e => { applyTheme(e.target.value); saveMonthlySettingsToLocalStorage(); }; if (lineThicknessSlider) { lineThicknessSlider.oninput = e => { applyLineThickness(e.target.value); }; lineThicknessSlider.onchange = () => saveMonthlySettingsToLocalStorage(); } if (fontFamilySelect) fontFamilySelect.onchange = e => { applyFontFamily(e.target.value); saveMonthlySettingsToLocalStorage(); }; if (saveSettingsButton) saveSettingsButton.onclick = handleSaveSettingsModalButtonClick; calendarBody.onclick = handleMonthlyCellClick; if (currentView === 'monthly') pageTitleElement.textContent = currentSettings.mainTitle; }
                function getCurrentSettings() { return { ...currentSettings }; }
                return { init, getCurrentSettings, generateCalendar };
            })();

            initializeToolbars(); 
            if (annualViewLogic) annualViewLogic.init();
            if (monthlyViewLogic) monthlyViewLogic.init();
            setActiveView(currentView); // Establecer la vista inicial y la configuración de la barra de herramientas
        });
    </script>

</body>
</html>
